<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Dex</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<blockquote>
<p>æ‰€æœ‰ä¿¡æ¯éƒ½æ¥è‡ª</p>

<p><a href="https://source.android.com/devices/tech/dalvik/dex-format.html">dex-format</a>ã€<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html">davik-bytecode</a>ã€<a href="https://source.android.com/devices/tech/dalvik/instruction-formats.html">instruction-formats</a>ä»¥åŠAOSPçš„<code>AOSP/dalvik/libdex/</code>ç›®å½•ä¸‹æºç ï¼Œ<code>leb128</code>çš„è§£ç æºç åœ¨<code>AOSP/libcore/dex/src/main/java/com/android/dex/Leb128.java</code>ã€‚</p>
</blockquote>

<p>Dexï¼šDalvik Executable formatï¼Œå³Dalvikå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚å®é™…ä¸Šåœ¨5.0ä¹‹å‰çš„è®¾å¤‡ä¸Šï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨æ—¶ä¼šæ‰§è¡Œ<code>dexopt</code>ï¼Œå³dexä¼˜åŒ–ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šç”Ÿæˆ<code>odex</code>æ–‡ä»¶ï¼Œä»¥åæ¯æ¬¡éƒ½ç›´æ¥åŠ è½½ä¼˜åŒ–è¿‡åçš„<code>odex</code>æ–‡ä»¶ï¼ˆ2.xçš„æœºå­ä¸Šè¿™ä¸ªè¿‡ç¨‹éå¸¸æ…¢ï¼Œç»å¸¸å¯¼è‡´åº”ç”¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶é»‘å±ï¼Œç”šè‡³ANRï¼‰ï¼›åœ¨5.0åŠä»¥åï¼ŒAndroidä¸å†ä½¿ç”¨Dalvikï¼Œæ–°çš„è™šæ‹Ÿæœºä¸ºARTï¼Œä¸è¿‡dexä»ç„¶æ˜¯å¿…é¡»çš„ï¼ŒARTä¹Ÿä¼šè¿›è¡Œdexä¼˜åŒ–ï¼Œåä¸º<code>dex2oat</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å’ŒDalvikä¸ä¸€æ ·ï¼Œæ˜¯åœ¨å®‰è£…æ—¶è¿›è¡Œçš„ï¼Œæ‰€ä»¥5.0åŠä»¥åçš„è®¾å¤‡å®‰è£…åº”ç”¨çš„è¿‡ç¨‹ä¼šæ¯”è¾ƒè€—æ—¶ã€‚<code>dexopt</code>å’Œ<code>dex2oat</code>ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ã€‚</p>

<p>åœ¨åŠ¨æ‰‹ä¹‹å‰ï¼Œæœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µéœ€è¦äº†è§£ä¸€ä¸‹ï¼š</p>

<h3 id="toc_0">å­—èŠ‚åº</h3>

<p>å³å­—èŠ‚é¡ºåºï¼Œåˆ†ä¸ºå¤§ç«¯åºã€å°ç«¯åºå’Œæ··åˆåºã€‚è¯¦ç»†å¯ä»¥å‚è€ƒ<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F">ç»´åŸºç™¾ç§‘</a>ï¼Œè¿™é‡Œä»¥Dexæ–‡ä»¶ç»“æ„ç®€å•è¯´ä¸€ä¸‹ï¼Œä»freelineçš„äº§å‡ºæ–‡ä»¶ä¸­æ‹¿åˆ°ä¸€ä¸ªclasses.dexæ–‡ä»¶ï¼ŒæŸ¥çœ‹å¤§å°ä¸º<code>12296</code>å­—èŠ‚ï¼Œåå…­è¿›åˆ¶æ˜¯<code>0x3008</code>ï¼Œå¦‚æœä»¥å¤§ç«¯åºå­˜å‚¨ï¼Œåº”è¯¥ä¸º<code>00 00 30 08</code>ï¼Œå°ç«¯åºåº”è¯¥ä¸º<code>08 30 00 00</code>ï¼ˆæ•°æ®ä»¥8bitä¸ºå•ä½å­˜å‚¨ï¼‰ã€‚</p>

<h3 id="toc_1">Leb128</h3>

<p>Little-Endian Base 128ï¼Œè¯¦ç»†ä¿¡æ¯åœ¨<a href="http://dwarfstd.org/Dwarf3Std.php">DWARF3</a>ã€‚ç®€å•ç‚¹è¯´å°±æ˜¯æ•°æ®å¯å˜é•¿åº¦çš„ç¼–ç æ–¹å¼ï¼Œåœ¨dexæ–‡ä»¶ä¸­ï¼Œä½¿ç”¨0ï¼5ä½å­—èŠ‚æ¥ç¼–ç 32ä½æ•´æ•°ã€‚æ•°æ®å­˜å‚¨æ–¹å¼ä¹Ÿæ˜¯å°ç«¯åºï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä½æ˜¯1ï¼Œåˆ™ç»§ç»­è¯»ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œä¾æ¬¡è¯»å–ï¼Œæœ€å¤šåªèƒ½è¯»5ä¸ªå­—èŠ‚ï¼Œå¦‚æœç¬¬5ä¸ªå­—èŠ‚è¿˜æ˜¯1åˆ™dexæ— æ•ˆã€‚</p>

<p>Leb128æœ‰3ç§ç±»å‹ï¼š<code>sleb128</code>ï¼ˆsigned LEB128ï¼Œç¼–ç åºåˆ—çš„æœ€å1ä½è¡¨ç¤ºå€¼çš„ç¬¦å·ï¼Œ1è¡¨ç¤ºè´Ÿæ•°ï¼‰ã€<code>uleb128</code>ï¼ˆunsigned LEB128ï¼‰å’Œ<code>uleb128p1</code>ï¼ˆ<code>uleb128</code>çš„å€¼å‡ä¸€ï¼‰ã€‚ä¸¾ä¸ªğŸŒ°ï¼Œè§£ç <code>leb128</code>ç¼–ç çš„å€¼<code>80 7f</code>ï¼ŒäºŒè¿›åˆ¶å­˜å‚¨æ–¹å¼ä¸º<code>1000 0000 0111 1111</code>ï¼š</p>

<p><code>sleb128</code>ï¼šæ€»å…±æœ‰ä¸¤ä¸ªå­—èŠ‚ï¼Œç¼–ç åºåˆ—çš„æœ€åä¸€ä½ä¸º1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼ŒçœŸå®å€¼çš„äºŒè¿›åˆ¶ç¼–ç ï¼ˆè¡¥ç ï¼‰ä¸º<code>-11111 1000 0000</code>ï¼ŒåŸç ä¸º<code>-1000 0000</code>ï¼Œä¹Ÿå³<code>-128</code>ã€‚</p>

<p><code>uleb128</code>ï¼šè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œåˆ†åˆ«å–æ‰ä¸¤ä¸ªå­—èŠ‚çš„æœ€é«˜ä½ï¼Œç»“æœä¸º<code>000 0000 111 1111</code>ï¼ŒçœŸå®å€¼ä¹Ÿå°±æ˜¯<code>111 1111 000 0000</code>ï¼Œä¹Ÿå³<code>16256</code></p>

<p><code>uleb128p1</code>ï¼šè¿™ä¸ªçš„å€¼å°±æ˜¯<code>uleb128</code>çš„å€¼å‡1ã€‚</p>

<p><code>AOSP</code>ä¸­æä¾›äº†è§£ç <code>leb128</code>çš„<code>c</code>å’Œ<code>java</code>ä»£ç ã€‚</p>

<h2 id="toc_2">Dexæ–‡ä»¶ç»“æ„</h2>

<p>ä»<a href="https://source.android.com/devices/tech/dalvik/dex-format.html#file-layout">å®˜æ–¹æ–‡æ¡£</a>ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª<code>.dex</code>æ–‡ä»¶ä¸»è¦åˆ†ä¸º3å±‚ï¼šå¤´ä¿¡æ¯ã€ç´¢å¼•è¡¨ã€æ•°æ®åŒºã€‚å…¶ä¸­ç´¢å¼•è¡¨ä¸­åˆåˆ†ä¸ºäº†<code>string_ids</code>ã€<code>type_ids</code>ã€<code>proto_ids</code>ã€<code>field_ids</code>ã€<code>method_ids</code>ã€<code>class_defs</code>ã€‚</p>

<p>åé¢å†ä¸€æ­¥æ­¥ä»”ç»†åˆ†æï¼Œå…ˆç®€å•è¯´ä¸€ä¸‹ï¼šå¤´ä¿¡æ¯ä¸­å­˜å‚¨äº†æ–‡ä»¶çš„ä¸€äº›æ¦‚è¦ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶å¤§å°ã€ç‰ˆæœ¬ã€æ ¡éªŒä¿¡æ¯ã€è¿˜æœ‰<code>string</code>çš„æ•°é‡åŠ<code>string_ids</code>åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ã€<code>type</code>çš„æ•°é‡ä»¥åŠ<code>type_ids</code>åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ç­‰ç­‰ã€‚</p>

<p>æ ¹æ®å¤´ä¿¡æ¯ä¸­çš„æ•°æ®å¯ä»¥æ‰¾åˆ°å„ç§ç´¢å¼•åŒºçš„ä½ç½®ï¼Œç„¶ååœ¨ç´¢å¼•åŒºçš„æ•°æ®ä¸­å¯ä»¥æ‰¾åˆ°å½“å‰ç±»å‹æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„å­˜å‚¨ä½ç½®ã€‚æ¯”å¦‚ä¸‹é¢<code>Hello.dex</code>ä¸­ï¼Œä»å¤´ä¿¡æ¯ä¸­å¯ä»¥çŸ¥é“æœ‰14ä¸ª<code>string</code>ä»¥åŠ<code>string_ids</code>çš„ä½ç½®ï¼Œè§£æ<code>string_id</code>å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²çš„ä½ç½®ã€‚</p>

<h3 id="toc_3">å®æˆ˜</h3>

<p>æŒæ¡ä¸Šé¢çš„çŸ¥è¯†åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»“åˆ<a href="https://source.android.com/devices/tech/dalvik/dex-format.html#file-layout">å®˜æ–¹æ–‡æ¡£</a>å’ŒAOSPæºç æ¥è§£æä¸€ä¸ª<code>.dex</code>æ–‡ä»¶äº†ã€‚AOSPä¸­ç”¨åˆ°çš„æ–‡ä»¶æœ‰ï¼š</p>

<div><pre><code class="language-none">dalvik/libdex/DexFile.h
dalvik/libdex/DexFile.cpp
dalvik/libdex/DexClass.h
libcore/dex/src/main/java/com/android/dex/Leb128.java</code></pre></div>

<h3 id="toc_4">Hello World</h3>

<p>æˆ‘ä»¬æ¥ç”Ÿæˆä¸€ä¸ªæœ€ç®€å•çš„<code>.dex</code>æ–‡ä»¶ã€‚</p>

<p>é¦–å…ˆï¼Œå†™ä¸€ä¸ª<code>HelloWorld.java</code>ï¼š</p>

<div><pre><code class="language-none">public class HelloWorld {
  public static void main(String[] argc) {
    System.out.println(&quot;Hello, Dex!\n&quot;);
  }
}</code></pre></div>

<p>ç¼–è¯‘ä¸º<code>.class</code>æ–‡ä»¶ï¼Œæˆ‘æœ¬åœ°<code>jdk</code>ç‰ˆæœ¬ä¸º1.8ï¼Œæ‰€ä»¥éœ€è¦åŠ å‚æ•°ï¼š</p>

<p><code>javac HelloWorld.java -source 1.7 -target 1.7</code></p>

<p>å°†<code>.class</code>æ–‡ä»¶ç¼–è¯‘ä¸º<code>.dex</code>æ–‡ä»¶ï¼š</p>

<p><code>dx --dex --output=Hello.dex HelloWorld.class</code></p>

<p>æœ€åäº§å‡º<code>Hello.dex</code>æ–‡ä»¶ã€‚</p>

<h3 id="toc_5">Header Section</h3>

<table>
<thead>
<tr>
<th>name</th>
<th>format</th>
<th>description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>magic</code></td>
<td><code>ubyte[8]</code></td>
<td>é­”æœ¯ï¼Œç”¨æ¥è¯†åˆ«<code>.dex</code>æ–‡ä»¶ï¼Œç»å¤§å¤šæ•°çš„<code>.dex</code>æ–‡ä»¶å€¼ä¸º<code>dex\n035\0</code></td>
</tr>
<tr>
<td><code>checksum</code></td>
<td><code>uint</code></td>
<td>é™¤<code>magic</code>å’Œ<code>checksum</code>å¤–æ‰€æœ‰å­—èŠ‚çš„<code>adler32</code>å€¼</td>
</tr>
<tr>
<td><code>signature</code></td>
<td><code>ubyte[20]</code></td>
<td>é™¤<code>magic</code>ã€<code>checksum</code>ã€<code>signature</code>å¤–æ‰€æœ‰å­—èŠ‚çš„<code>SHA-1</code></td>
</tr>
<tr>
<td><code>file_size</code></td>
<td><code>uint</code></td>
<td>æ–‡ä»¶å¤§å°</td>
</tr>
<tr>
<td><code>header_size</code></td>
<td><code>uint</code></td>
<td>Header Sectionçš„å¤§å°ï¼Œå›ºå®šä¸º0x70ä¹Ÿå°±æ˜¯112å­—èŠ‚</td>
</tr>
<tr>
<td><code>endian_tag</code></td>
<td><code>uint</code></td>
<td>å¤§å°ç«¯æ ‡è®°ï¼Œ<code>.dex</code>å›ºå®šä¸º<code>78563412</code></td>
</tr>
<tr>
<td><code>link_size</code></td>
<td><code>uint</code></td>
<td>ä¿ç•™å­—æ®µï¼Œå¹¶æ²¡æœ‰ç”¨åˆ°ï¼Œå€¼ä¸º0</td>
</tr>
<tr>
<td><code>link_off</code></td>
<td><code>uint</code></td>
<td>ä¿ç•™å­—æ®µï¼Œå¹¶æ²¡æœ‰ç”¨åˆ°ï¼Œå€¼ä¸º0</td>
</tr>
<tr>
<td><code>map_off</code></td>
<td><code>uint</code></td>
<td>mapæ•°æ®çš„ä½ç½®ï¼Œå¿…å®šä¸ºé0å€¼</td>
</tr>
<tr>
<td><code>string_ids_size</code></td>
<td><code>uint</code></td>
<td><code>string</code>çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>string_ids_off</code></td>
<td><code>uint</code></td>
<td><code>string_id</code>åˆ—è¡¨çš„ä½ç½®ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>type_ids_size</code></td>
<td><code>uint</code></td>
<td><code>type</code>çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0ï¼Œæœ€å¤§å€¼ä¸º65535</td>
</tr>
<tr>
<td><code>type_ids_off</code></td>
<td><code>uint</code></td>
<td><code>type_id</code>åˆ—è¡¨çš„ä½ç½®ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>proto_ids_size</code></td>
<td><code>uint</code></td>
<td><code>prototype</code>çš„æ•°é‡ï¼Œæœ€å¤§å€¼ä¸º65535</td>
</tr>
<tr>
<td><code>proto_ids_off</code></td>
<td><code>uint</code></td>
<td><code>proto_id</code>åˆ—è¡¨çš„ä½ç½®ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>field_ids_size</code></td>
<td><code>uint</code></td>
<td><code>field</code>çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>field_ids_off</code></td>
<td><code>uint</code></td>
<td><code>field_id</code>åˆ—è¡¨çš„ä½ç½®ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>method_ids_size</code></td>
<td><code>uint</code></td>
<td><code>method</code>çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>method_ids_off</code></td>
<td><code>uint</code></td>
<td><code>method_id</code>åˆ—è¡¨çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>class_defs_size</code></td>
<td><code>uint</code></td>
<td>ç±»å®šä¹‰ï¼ˆclass definitionsï¼‰çš„æ•°é‡ï¼Œå¯ä»¥ä¸º0</td>
</tr>
<tr>
<td><code>class_defs_off</code></td>
<td><code>uint</code></td>
<td>ç±»å®šä¹‰åˆ—è¡¨çš„ä½ç½®</td>
</tr>
<tr>
<td><code>data_size</code></td>
<td><code>uint</code></td>
<td>æ•°æ®åŒºå¤§å°</td>
</tr>
<tr>
<td><code>data_off</code></td>
<td><code>uint</code></td>
<td>æ•°æ®åŒºçš„ä½ç½®</td>
</tr>
</tbody>
</table>

<p>Header Sectionçš„ç»“æ„å°±æ˜¯è¿™æ ·ï¼Œè§£æçš„ä»£ç æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Okio</code>ï¼Œ<code>Okio</code>ä¸­æä¾›äº†å°ç«¯å­˜å‚¨æ•°æ®çš„è¯»å–æ–¹æ³•ï¼Œå¦‚<code>readIntLe()</code>ã€<code>readShortLe()</code>ç­‰ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">public static DexHeader parse(File DEX) throws IOException {
        DexHeader dexHeader = new DexHeader();
        BufferedSource buffer = Okio.buffer(Okio.source(DEX));
        dexHeader.magic = Utils.readByteString(buffer, 8).utf8();
        dexHeader.checksum = Utils.readByteString(buffer, 4).hex();
        dexHeader.signature = Utils.readByteString(buffer, 20).hex();
        dexHeader.fileSize = buffer.readIntLe();
        dexHeader.headerSize = buffer.readIntLe();
        dexHeader.endianTag = Utils.readByteString(buffer, 4).hex();
        dexHeader.linkSize = buffer.readIntLe();
        dexHeader.linkOff = buffer.readIntLe();
        dexHeader.mapOff = buffer.readIntLe();
        dexHeader.stringIdsSize = buffer.readIntLe();
        dexHeader.stringIdsOff = buffer.readIntLe();
        dexHeader.typeIdsSize = buffer.readIntLe();
        dexHeader.typeIdsOff = buffer.readIntLe();
        dexHeader.protoIdsSize = buffer.readIntLe();
        dexHeader.protoIdsOff = buffer.readIntLe();
        dexHeader.fieldIdsSize = buffer.readIntLe();
        dexHeader.fieldIdsOff = buffer.readIntLe();
        dexHeader.methodIdsSize = buffer.readIntLe();
        dexHeader.methodIdsOff = buffer.readIntLe();
        dexHeader.classDefsSize = buffer.readIntLe();
        dexHeader.classDefsOff = buffer.readIntLe();
        dexHeader.dataSize = buffer.readIntLe();
        dexHeader.dataOff = buffer.readIntLe();
        return dexHeader;
    }</code></pre></div>

<p>ç»“æœä¸ºï¼š</p>

<table>
<thead>
<tr>
<th>name</th>
<th>value</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>magic</code></td>
<td><code>dex\n035\0</code></td>
</tr>
<tr>
<td><code>checksum</code></td>
<td><code>1d5fbfb9</code></td>
</tr>
<tr>
<td><code>signature</code></td>
<td><code>bbcc4e506837a4d62250491c6b9eac195cf5269d</code></td>
</tr>
<tr>
<td><code>file_size</code></td>
<td><code>744</code></td>
</tr>
<tr>
<td><code>header_size</code></td>
<td><code>112</code></td>
</tr>
<tr>
<td><code>endian_tag</code></td>
<td><code>78563412</code></td>
</tr>
<tr>
<td><code>link_size</code></td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>link_off</code></td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>map_off</code></td>
<td><code>584</code></td>
</tr>
<tr>
<td><code>string_ids_size</code></td>
<td><code>14</code></td>
</tr>
<tr>
<td><code>string_ids_off</code></td>
<td><code>112</code></td>
</tr>
<tr>
<td><code>type_ids_size</code></td>
<td><code>7</code></td>
</tr>
<tr>
<td><code>type_ids_off</code></td>
<td><code>168</code></td>
</tr>
<tr>
<td><code>proto_ids_size</code></td>
<td><code>3</code></td>
</tr>
<tr>
<td><code>proto_ids_off</code></td>
<td><code>196</code></td>
</tr>
<tr>
<td><code>field_ids_size</code></td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>field_ids_off</code></td>
<td><code>232</code></td>
</tr>
<tr>
<td><code>method_ids_size</code></td>
<td><code>4</code></td>
</tr>
<tr>
<td><code>method_ids_off</code></td>
<td><code>240</code></td>
</tr>
<tr>
<td><code>class_defs_size</code></td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>class_defs_off</code></td>
<td><code>272</code></td>
</tr>
<tr>
<td><code>data_size</code></td>
<td><code>440</code></td>
</tr>
<tr>
<td><code>data_off</code></td>
<td><code>304</code></td>
</tr>
</tbody>
</table>

<p>æˆ‘ä»¬å¯ä»¥éªŒè¯ä¸€ä¸‹<code>checksum</code>å’Œ<code>signature</code>ï¼š</p>

<div><pre><code class="language-none">private static void verifyCheckSum(File DEX, DexFile dexFile) throws IOException {
        BufferedSource source = Okio.buffer(Okio.source(DEX));
        source.skip(8);// magic
        source.skip(4);// checksum
        Adler32 adler32 = new Adler32();
        adler32.update(source.readByteArray());
        Buffer buffer = new Buffer();
        buffer.writeIntLe((int) adler32.getValue());
        String checksum = buffer.readByteString().hex();
        System.out.println(checksum.equals(dexFile.dexHeader.checksum));
    }
    
private static void verifySignature(File DEX, DexFile dexFile) throws IOException {
        BufferedSource source = Okio.buffer(Okio.source(DEX));
        source.skip(8);// magic
        source.skip(4);// checksum
        source.skip(20);// signature
        String signature = source.readByteString().sha1().hex();
        System.out.println(signature.equals(dexFile.dexHeader.signature));
    }</code></pre></div>

<p>ç»“æœéƒ½ä¸º<code>true</code>ã€‚</p>

<h3 id="toc_6">String</h3>

<p>ä»Headerä¸­å¯ä»¥çŸ¥é“<code>string_ids</code>åŒºçš„ä½ç½®ï¼Œè¿™ä¸ªåŒºä¸­å­˜å‚¨çš„æ˜¯<code>string_id_item</code>çš„åˆ—è¡¨ï¼Œ<code>string_id_item</code>ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªåä¸º<code>string_data_off</code>çš„<code>uint</code>ç±»å‹å€¼ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºå¯¹åº”çš„<code>string_data_item</code>åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ï¼Œè¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<p><code>string_id_item</code>çš„ç»“æ„ï¼š</p>

<table>
<thead>
<tr>
<th>name</th>
<th>format</th>
<th>description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>string_data_off</code></td>
<td><code>uint</code></td>
<td>å¯¹åº”çš„<code>string_data_item</code>åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®</td>
</tr>
</tbody>
</table>

<p><code>string_data_item</code>çš„ç»“æ„ï¼š</p>

<table>
<thead>
<tr>
<th>name</th>
<th>format</th>
<th>description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>utf16_size</code></td>
<td><code>uleb128</code></td>
<td>å­—ç¬¦ä¸²é•¿åº¦</td>
</tr>
<tr>
<td><code>data</code></td>
<td><code>ubyte[]</code></td>
<td>å­—ç¬¦ä¸²çš„å†…å®¹ï¼ŒMUTF-8æ ¼å¼</td>
</tr>
</tbody>
</table>

<p>è§£ææ•°æ®ï¼š</p>

<div><pre><code class="language-none">public static ArrayList&lt;DexStringId&gt; parse(File DEX, DexHeader dexHeader) throws IOException {
        BufferedSource buffer = Okio.buffer(Okio.source(DEX));
        buffer.skip(dexHeader.stringIdsOff);
        int len = dexHeader.stringIdsSize;
        ArrayList&lt;DexStringId&gt; dexStringIds = new ArrayList&lt;&gt;(len);
        for (int i = 0; i &lt; len; i++) {
            DexStringId dexStringId = new DexStringId();
            dexStringId.stringDataOff = buffer.readIntLe();
            dexStringIds.add(dexStringId);
        }
        return dexStringIds;
    }

public static ArrayList&lt;StringDataItem&gt; parse(File DEX, List&lt;DexStringId&gt; dexStringIds) throws IOException {
        ArrayList&lt;StringDataItem&gt; stringDataItems = new ArrayList&lt;&gt;(dexStringIds.size());
        int len = dexStringIds.size();
        System.err.println(&quot;len &quot; + len);
        for (int i = 0; i &lt; len; i++) {
            BufferedSource bufferedSource = Okio.buffer(Okio.source(DEX));
            bufferedSource.skip(dexStringIds.get(i).stringDataOff);
            StringDataItem stringDataItem = new StringDataItem();
            int leb128 = Utils.readUnsignedLeb128_4(bufferedSource);
            stringDataItem.utf16_size = leb128;
            stringDataItem.data = Utils.readByteString(bufferedSource, leb128).utf8();
            stringDataItems.add(stringDataItem);
        }
        return stringDataItems;
    }</code></pre></div>

<p>è§£æ<code>string_data_item</code>çš„ä»£ç æ¯”è¾ƒè›‹ç–¼ï¼Œæ˜¯å› ä¸ºæˆ‘åœ¨ä½¿ç”¨æˆ‘ä»¬äº§å“çš„<code>.dex</code>æ–‡ä»¶æ—¶ä¼šå‡ºé—®é¢˜ï¼Œè¯»å–çš„<code>uleb128</code>ä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²é•¿åº¦ä¸å¯¹ï¼Œå¯èƒ½æ•°æ®åŒºä¸­å­˜å‚¨ä¸æ˜¯è¿ç»­çš„ã€‚ç»“æœå¦‚ä¸‹ï¼Œæˆ‘æŠŠä¸¤ç§æ•°æ®ç»¼åˆäº†ä¸€ä¸‹ï¼š</p>

<table>
<thead>
<tr>
<th>index</th>
<th>string_data_off</th>
<th>utf16_size</th>
<th>data</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>374</td>
<td>6</td>
<td>&lt;init&gt;</td>
</tr>
<tr>
<td>1</td>
<td>382</td>
<td>12</td>
<td>Hello, Dex!</td>
</tr>
<tr>
<td>2</td>
<td>396</td>
<td>15</td>
<td>HelloWorld.java</td>
</tr>
<tr>
<td>3</td>
<td>413</td>
<td>12</td>
<td>LHelloWorld;</td>
</tr>
<tr>
<td>4</td>
<td>427</td>
<td>21</td>
<td>Ljava/io/PrintStream;</td>
</tr>
<tr>
<td>5</td>
<td>450</td>
<td>18</td>
<td>Ljava/lang/Object;</td>
</tr>
<tr>
<td>6</td>
<td>470</td>
<td>18</td>
<td>Ljava/lang/String;</td>
</tr>
<tr>
<td>7</td>
<td>490</td>
<td>18</td>
<td>Ljava/lang/System;</td>
</tr>
<tr>
<td>8</td>
<td>510</td>
<td>1</td>
<td>V</td>
</tr>
<tr>
<td>9</td>
<td>513</td>
<td>2</td>
<td>VL</td>
</tr>
<tr>
<td>10</td>
<td>517</td>
<td>19</td>
<td>[Ljava/lang/String;</td>
</tr>
<tr>
<td>11</td>
<td>538</td>
<td>4</td>
<td>main</td>
</tr>
<tr>
<td>12</td>
<td>544</td>
<td>3</td>
<td>out</td>
</tr>
<tr>
<td>13</td>
<td>549</td>
<td>7</td>
<td>println</td>
</tr>
</tbody>
</table>

<h3 id="toc_7">Typeã€Protoã€Fieldã€Method</h3>

<p>è¿™å‡ ç§éƒ½ä¸ç»†è¯´äº†ï¼Œå’Œå­—ç¬¦ä¸²ä¸€æ ·ï¼Œç»“æœæ•´ç†å¦‚ä¸‹ï¼š</p>

<p><code>type</code>:</p>

<table>
<thead>
<tr>
<th>index</th>
<th>descriptor_idx</th>
<th>descriptor</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>3</td>
<td>LHelloWorld;</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
<td>Ljava/io/PrintStream;</td>
</tr>
<tr>
<td>2</td>
<td>5</td>
<td>Ljava/lang/Object;</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>Ljava/lang/String;</td>
</tr>
<tr>
<td>4</td>
<td>7</td>
<td>Ljava/lang/System;</td>
</tr>
<tr>
<td>5</td>
<td>8</td>
<td>V</td>
</tr>
<tr>
<td>6</td>
<td>10</td>
<td>[Ljava/lang/String;</td>
</tr>
</tbody>
</table>

<p><code>prototype</code>:</p>

<table>
<thead>
<tr>
<th>index</th>
<th>shortyDesc</th>
<th>returnType</th>
<th>parameters size</th>
<th>parameters</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>V</td>
<td>V</td>
<td>0</td>
<td>-</td>
</tr>
<tr>
<td>1</td>
<td>VL</td>
<td>V</td>
<td>1</td>
<td>Ljava/lang/String;</td>
</tr>
<tr>
<td>2</td>
<td>VL</td>
<td>V</td>
<td>1</td>
<td>[Ljava/lang/String;</td>
</tr>
</tbody>
</table>

<p><code>field</code>:</p>

<table>
<thead>
<tr>
<th>index</th>
<th>name</th>
<th>definingClass</th>
<th>type</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>out</td>
<td>Ljava/lang/System;</td>
<td>Ljava/io/PrintStream;</td>
</tr>
</tbody>
</table>

<p><code>method</code>:</p>

<table>
<thead>
<tr>
<th>index</th>
<th>name</th>
<th>class</th>
<th>prototype</th>
<th>returnType</th>
<th>parameters size</th>
<th>parameters</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>&lt;init&gt;</td>
<td>LHelloWorld;</td>
<td>V</td>
<td>V</td>
<td>0</td>
<td>-</td>
</tr>
<tr>
<td>1</td>
<td>main</td>
<td>LHelloWorld;</td>
<td>VL</td>
<td>V</td>
<td>1</td>
<td>[Ljava/lang/String;</td>
</tr>
<tr>
<td>2</td>
<td>println</td>
<td>Ljava/io/PrintStream;</td>
<td>VL</td>
<td>V</td>
<td>1</td>
<td>Ljava/lang/String;</td>
</tr>
<tr>
<td>3</td>
<td>&lt;init&gt;</td>
<td>Ljava/lang/Object;</td>
<td>V</td>
<td>V</td>
<td>0</td>
<td>-</td>
</tr>
</tbody>
</table>

<h3 id="toc_8">ClassDef</h3>

<p>ç±»çš„å®šä¹‰ï¼Œè§£æè¿‡ç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼Œçœ‹æ–‡æ¡£åŠæºç å°±è¡Œäº†ï¼š</p>

<table>
<thead>
<tr>
<th>index</th>
<th>class</th>
<th>accessFlags</th>
<th>superClass</th>
<th>interfaces</th>
<th>sourceFile</th>
<th>annotations</th>
<th>staticValues</th>
<th>annotationsDirectoryItem</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>LHelloWorld;</td>
<td>ACC_PUBLIC</td>
<td>Ljava/lang/Object;</td>
<td>-</td>
<td>HelloWorld.java</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>

<p>ä¸Šé¢æ˜¯åŸºæœ¬ä¿¡æ¯ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ª<code>class_data_off</code>ï¼ŒæŒ‡å‘<code>class_data_item</code>çš„ä½ç½®ï¼Œè¿™ä¸ªé‡Œé¢å­˜å‚¨äº†å½“å‰<code>class</code>ä¸­<code>static</code>å­—æ®µã€å®ä¾‹å­—æ®µã€ç›´æ¥æ–¹æ³•ï¼ˆdirect methodsï¼Œ<code>private</code>æˆ–è€…æ„é€ æ–¹æ³•ï¼‰ã€è™šæ–¹æ³•ï¼ˆvirtual methodsï¼Œé<code>private</code>ã€<code>static</code>ã€<code>final</code>ï¼Œéæ„é€ æ–¹æ³•ï¼‰çš„ä¿¡æ¯ï¼Œåœ¨å½“å‰ğŸŒ°ä¸­é™æ€å­—æ®µã€å®ä¾‹å­—æ®µã€è™šæ–¹æ³•éƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†æä¸¤ä¸ªç›´æ¥æ–¹æ³•ï¼š</p>

<p><code>class_data_item</code>ä¸­çš„<code>direct_methods</code>ç¼–ç æ–¹å¼ä¸º<code>encoded_method</code>ï¼Œå®ƒé‡Œé¢æè¿°äº†è¯¥æ–¹æ³•åœ¨<code>method_ids</code>ä¸­çš„ç´¢å¼•å’Œä¿®é¥°ç¬¦ï¼ˆ<code>method_ids</code>ä¸­æ²¡æœ‰ä¿®é¥°ç¬¦ï¼‰ä»¥åŠæ–¹æ³•ä¸­ä»£ç å—çš„ä½ç½®ï¼ˆ<code>code_off</code>ï¼‰ï¼Œä»£ç å—çš„ç¼–ç æ–¹å¼ä¸º<code>code_item</code>ï¼Œè§£æ<code>code_item</code>æ˜¯æˆ‘ä»¬å°†å½“å‰ç±»å®šä¹‰ç¿»è¯‘æˆsmaliè¯­æ³•çš„å…³é”®ï¼š</p>

<p><code>code_item</code>:</p>

<table>
<thead>
<tr>
<th>Name</th>
<th>Format</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>registers_size</code></td>
<td><code>ushort</code></td>
<td>å½“å‰ä»£ç å—ä½¿ç”¨åˆ°çš„å¯„å­˜å™¨æ•°é‡</td>
</tr>
<tr>
<td><code>ins_size</code></td>
<td><code>ushort</code></td>
<td>ä¼ å…¥å½“å‰methodçš„å‚æ•°æ•°é‡ï¼Œåé¢çš„ç»“æœä¸­é»˜è®¤çš„æ„é€ æ–¹æ³•ä¸­è¿™ä¸ªå€¼æ˜¯1ï¼ŒåŸå› æ˜¯æœ‰ä¸ª<code>this</code>ï¼Œé™æ€æ–¹æ³•æ²¡<code>this</code></td>
</tr>
<tr>
<td><code>outs_size</code></td>
<td><code>ushort</code></td>
<td>å½“å‰ä»£ç å—ä¸­è°ƒç”¨å…¶å®ƒæ–¹æ³•çš„å‚æ•°æ•°é‡</td>
</tr>
<tr>
<td><code>tries_size</code></td>
<td><code>ushort</code></td>
<td>ä»£ç å—ä¸­å¼‚å¸¸å¤„ç†çš„æ•°é‡</td>
</tr>
<tr>
<td><code>debug_info_off</code></td>
<td><code>uint</code></td>
<td>è°ƒè¯•ä¿¡æ¯çš„ä½ç½®ï¼Œè°ƒè¯•ä¿¡æ¯ä¸­åŒ…å«3ä¸ªå€¼ï¼šå½“å‰ä»£ç å—åœ¨æºæ–‡ä»¶ä¸­çš„èµ·å§‹è¡Œæ•°ã€æ–¹æ³•çš„å‚æ•°æ•°é‡ã€æ–¹æ³•å‚æ•°åçš„åˆ—è¡¨</td>
</tr>
<tr>
<td><code>insns_size</code></td>
<td><code>uint</code></td>
<td>æŒ‡ä»¤çš„æ•°é‡ï¼ŒæŒ‡ä»¤æ˜¯16ä½ç¼–ç çš„</td>
</tr>
<tr>
<td><code>insns</code></td>
<td><code>ushort</code></td>
<td>æŒ‡ä»¤åˆ—è¡¨ï¼Œè¯¦ç»†ä¿¡æ¯åœ¨<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html">Dalvik bytecode</a></td>
</tr>
<tr>
<td><code>padding</code></td>
<td><code>ushort(optional)=0</code></td>
<td></td>
</tr>
<tr>
<td><code>tries</code></td>
<td><code>try_item[tries_size] (optional)</code></td>
<td></td>
</tr>
<tr>
<td><code>handlers</code></td>
<td><code>encoded_catch_handler_list (optional)</code></td>
<td></td>
</tr>
</tbody>
</table>

<p>å…ˆçœ‹ä¸¤ä¸ª<code>direct method</code>çš„<code>code_item</code>ï¼š</p>

<table>
<thead>
<tr>
<th>index</th>
<th>method</th>
<th>registerSize</th>
<th>insSize</th>
<th>outsSize</th>
<th>triesSize</th>
<th>debugInfoOff</th>
<th>insnsSize</th>
<th>insns</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td><code>&lt;init&gt;</code></td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>558</td>
<td>4</td>
<td><code>1070 0003 0000 000e</code></td>
</tr>
<tr>
<td>1</td>
<td><code>main</code></td>
<td>3</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>563</td>
<td>8</td>
<td><code>0062 0000 011a 0001 206e 0002 0010 000e</code></td>
</tr>
</tbody>
</table>

<p>å…ˆçœ‹é»˜è®¤æ„é€ æ–¹æ³•çš„æŒ‡ä»¤ï¼š<code>1070 0003 0000 000e</code>ï¼Œä»<a href="https://source.android.com/devices/tech/dalvik/instruction-formats.html">instruction formats</a>ä¸­å¾—çŸ¥ï¼Œæ“ä½œç¬¦<code>op</code>æ˜¯åœ¨ç¬¬ä¸€ä¸ª<code>16bits</code>çš„ä½8ä½ï¼Œè¿™é‡Œ<code>op=70</code>ï¼Œä»<a href="https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html">dalvik bytecode</a>ä¸­å¾—çŸ¥ï¼š<code>70: invoke-direct</code>ï¼Œå¹¶ä¸”æŒ‡ä»¤æ ¼å¼ä¸º<code>35c</code>ï¼Œè¿”å›<strong>instruction formats</strong>ä¸­æŸ¥è¯¢<code>35c</code>ï¼Œå¾—çŸ¥æ ¼å¼ä¸º<code>A|G|op BBBB F|E|D|C</code>ï¼ŒæŸ¥çœ‹è¯­æ³•ï¼Œè¿™é‡Œ<code>A=1</code>ï¼Œæ‰€ä»¥è¯­æ³•ä¸º<code>[A=1] op {vC}, kind@BBBB</code>ï¼Œ<code>BBBB</code>æ˜¯<code>method_ids</code>ä¸­çš„ç´¢å¼•ï¼Œç¿»è¯‘ä¸€ä¸‹ï¼Œ<code>1070 0003 0000</code>çš„å«ä¹‰å°±æ˜¯ï¼š</p>

<p><code>invoke-direct {p0} Ljava/lang/Object;-&gt;&lt;init&gt;()V</code></p>

<p><code>000e</code>çš„å«ä¹‰æ˜¯<code>return-void</code>ï¼Œç»¼åˆä¸Šé¢çš„ä¿¡æ¯éƒ½å¯ä»¥å†™å‡ºç¬¬ä¸€ä¸ªæ–¹æ³•çš„<code>smali</code>è¯­æ³•å®šä¹‰ï¼š</p>

<div><pre><code class="language-none">.method public constructor &lt;init&gt;()V
    .registers 1
    invoke-direct { p0 }, Ljava/lang/Object;-&gt;&lt;init&gt;()V
    return-void
.end method</code></pre></div>

<p>å†çœ‹ç¬¬äºŒä¸ª<code>main</code>æ–¹æ³•ï¼Œ<code>0062 0000 011a 0001 206e 0002 0010 000e</code>ï¼š</p>

<p><code>0062 0000</code>çš„æ„æ€ä¸º<code>sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</code></p>

<p><code>011a 0001</code>ä½<code>const-string v1, &quot;Hello, Dex!\n&quot;</code></p>

<p>æœ€åçš„<code>206e 0002 0010</code>è¯­æ³•å’Œ<code>&lt;init&gt;</code>ä¸€æ ·ï¼Œè§£é‡Šä¸ºï¼š<code>invoke-virtual { v0, v1 }, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</code></p>

<p>æœ€ç»ˆå¾—åˆ°<code>main</code>æ–¹æ³•ï¼š</p>

<div><pre><code class="language-none">.method public static main([Ljava/lang/String;)V
    .registers 3
    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;
    const-string v1, &quot;Hello, Dex!\n&quot;
    invoke-virtual { v0, v1 }, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V
    .line 4
    return-void
.end method</code></pre></div>

<p>ä½¿ç”¨Android SDKä¸­çš„<code>dexdump</code>å·¥å…·ä¹Ÿå¯ä»¥çœ‹åˆ°<code>.dex</code>æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼š</p>

<div><pre><code class="language-none">âœ  dex dexdump -d Hello.dex
Processing &#39;Hello.dex&#39;...
Opened &#39;Hello.dex&#39;, DEX version &#39;035&#39;
Class #0            -
  Class descriptor  : &#39;LHelloWorld;&#39;
  Access flags      : 0x0001 (PUBLIC)
  Superclass        : &#39;Ljava/lang/Object;&#39;
  Interfaces        -
  Static fields     -
  Instance fields   -
  Direct methods    -
    #0              : (in LHelloWorld;)
      name          : &#39;&lt;init&gt;&#39;
      type          : &#39;()V&#39;
      access        : 0x10001 (PUBLIC CONSTRUCTOR)
      code          -
      registers     : 1
      ins           : 1
      outs          : 1
      insns size    : 4 16-bit code units
000130:                                        |[000130] HelloWorld.&lt;init&gt;:()V
000140: 7010 0300 0000                         |0000: invoke-direct {v0}, Ljava/lang/Object;.&lt;init&gt;:()V // method@0003
000146: 0e00                                   |0003: return-void
      catches       : (none)
      positions     :
        0x0000 line=1
      locals        :
        0x0000 - 0x0004 reg=0 this LHelloWorld;

    #1              : (in LHelloWorld;)
      name          : &#39;main&#39;
      type          : &#39;([Ljava/lang/String;)V&#39;
      access        : 0x0009 (PUBLIC STATIC)
      code          -
      registers     : 3
      ins           : 1
      outs          : 2
      insns size    : 8 16-bit code units
000148:                                        |[000148] HelloWorld.main:([Ljava/lang/String;)V
000158: 6200 0000                              |0000: sget-object v0, Ljava/lang/System;.out:Ljava/io/PrintStream; // field@0000
00015c: 1a01 0100                              |0002: const-string v1, &quot;Hello, Dex!
&quot; // string@0001
000160: 6e20 0200 1000                         |0004: invoke-virtual {v0, v1}, Ljava/io/PrintStream;.println:(Ljava/lang/String;)V // method@0002
000166: 0e00                                   |0007: return-void
      catches       : (none)
      positions     :
        0x0000 line=3
        0x0007 line=4
      locals        :

  Virtual methods   -
  source_file_idx   : 2 (HelloWorld.java)</code></pre></div>




</body>

</html>
